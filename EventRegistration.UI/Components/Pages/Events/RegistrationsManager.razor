@using EventRegistration.UI.Services
@using EventRegistration.UI.Models
@inject EventRegistrationApiClient ApiClient
@rendermode InteractiveServer

<div class="mb-4">
    <button class="btn btn-primary" @onclick="ToggleForm">
        <i class="bi bi-plus-circle"></i> Add Registration
    </button>
</div>

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-header">New Registration</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">First Name *</label>
                    <input class="form-control" @bind="newRegistration.FirstName" placeholder="Enter first name" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Last Name *</label>
                    <input class="form-control" @bind="newRegistration.LastName" placeholder="Enter last name" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-control" @bind="newRegistration.Email" placeholder="Enter email" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input class="form-control" @bind="newRegistration.Phone" placeholder="Enter phone number" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Ticket Type *</label>
                    <select class="form-select" @bind="newRegistration.TicketTypeId">
                        <option value="">Select a ticket type...</option>
                        @foreach (var ticket in TicketTypes)
                        {
                            <option value="@ticket.Id">@ticket.Name - $@ticket.Price.ToString("F2") (@ticket.AvailableCount available)</option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Discount Code</label>
                    <input class="form-control" @bind="newRegistration.DiscountCode" placeholder="Enter discount code (optional)" />
                </div>
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3">@errorMessage</div>
            }
            <div class="mt-3">
                <button class="btn btn-primary" @onclick="CreateRegistration" disabled="@isSubmitting">
                    @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                    Register
                </button>
                <button class="btn btn-secondary ms-2" @onclick="ToggleForm">Cancel</button>
            </div>
        </div>
    </div>
}

<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Ticket Type</th>
                <th>Amount Paid</th>
                <th>Status</th>
                <th>Registration Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (!registrations.Any())
            {
                <tr>
                    <td colspan="8" class="text-center">No registrations yet.</td>
                </tr>
            }
            @foreach (var reg in registrations)
            {
                var ticketType = TicketTypes.FirstOrDefault(t => t.Id == reg.TicketTypeId);
                <tr>
                    <td>@reg.FirstName @reg.LastName</td>
                    <td>@reg.Email</td>
                    <td>@(reg.PhoneNumber ?? "N/A")</td>
                    <td>@(ticketType?.Name ?? "Unknown")</td>
                    <td>$@reg.TotalAmount.ToString("F2")</td>
                    <td><span class="badge bg-@GetStatusColor(reg.Status)">@reg.Status</span></td>
                    <td>@reg.RegistrationDate.ToString("MMM dd, yyyy HH:mm")</td>
                    <td>
                        @if (reg.Status == "Confirmed")
                        {
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelRegistration(reg.Id)">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter] public int EventId { get; set; }
    [Parameter] public List<TicketTypeResponse> TicketTypes { get; set; } = new();
    [Parameter] public EventCallback OnChanged { get; set; }

    private List<RegistrationResponse> registrations = new();
    private bool showForm;
    private bool isSubmitting;
    private string? errorMessage;
    private NewRegistrationModel newRegistration = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRegistrations();
    }

    private async Task LoadRegistrations()
    {
        registrations = await ApiClient.GetRegistrationsAsync(EventId);
    }

    private void ToggleForm()
    {
        showForm = !showForm;
        if (showForm)
        {
            newRegistration = new();
            errorMessage = null;
        }
    }

    private async Task CreateRegistration()
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            if (newRegistration.TicketTypeId == 0)
            {
                errorMessage = "Please select a ticket type";
                return;
            }

            var request = new CreateRegistrationRequest(
                newRegistration.FirstName ?? "",
                newRegistration.LastName ?? "",
                newRegistration.Email ?? "",
                newRegistration.Phone,
                newRegistration.TicketTypeId,
                newRegistration.DiscountCode
            );

            await ApiClient.CreateRegistrationAsync(EventId, request);
            await LoadRegistrations();
            await OnChanged.InvokeAsync();
            ToggleForm();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task CancelRegistration(int registrationId)
    {
        try
        {
            await ApiClient.CancelRegistrationAsync(registrationId);
            await LoadRegistrations();
            await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private string GetStatusColor(string status) => status switch
    {
        "Confirmed" => "success",
        "Cancelled" => "danger",
        "Waitlisted" => "warning",
        _ => "secondary"
    };

    private class NewRegistrationModel
    {
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public int TicketTypeId { get; set; }
        public string? DiscountCode { get; set; }
    }
}
