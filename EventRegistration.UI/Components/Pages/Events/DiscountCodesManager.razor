@using EventRegistration.UI.Services
@using EventRegistration.UI.Models
@inject EventRegistrationApiClient ApiClient
@rendermode InteractiveServer

<div class="mb-4">
    <button class="btn btn-primary" @onclick="ToggleForm">
        <i class="bi bi-plus-circle"></i> Add Discount Code
    </button>
</div>

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-header">New Discount Code</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Code *</label>
                    <input class="form-control text-uppercase" @bind="newCode.Code" placeholder="e.g., EARLY2024" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Discount Type *</label>
                    <select class="form-select" @bind="newCode.DiscountType">
                        <option value="Percentage">Percentage</option>
                        <option value="FixedAmount">Fixed Amount</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Discount Value *</label>
                    <input type="number" step="0.01" class="form-control" @bind="newCode.DiscountValue"
                           placeholder="@(newCode.DiscountType == "Percentage" ? "Enter percentage (e.g., 10)" : "Enter amount (e.g., 5.00)")" />
                    <small class="text-muted">
                        @if (newCode.DiscountType == "Percentage")
                        {
                            <text>Enter percentage value (e.g., 10 for 10%)</text>
                        }
                        else
                        {
                            <text>Enter dollar amount (e.g., 5.00 for $5 off)</text>
                        }
                    </small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Maximum Uses</label>
                    <input type="number" class="form-control" @bind="newCode.MaxUses" placeholder="Leave empty for unlimited" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Valid From</label>
                    <input type="datetime-local" class="form-control" @bind="newCode.ValidFrom" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Valid Until</label>
                    <input type="datetime-local" class="form-control" @bind="newCode.ValidUntil" />
                </div>
                <div class="col-md-12">
                    <label class="form-label">Applicable Ticket Types</label>
                    <div class="card">
                        <div class="card-body">
                            @if (!TicketTypes.Any())
                            {
                                <p class="text-muted mb-0">No ticket types available. Create ticket types first.</p>
                            }
                            else
                            {
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" @bind="selectAllTickets" @onclick="ToggleAllTickets" />
                                    <label class="form-check-label fw-bold">Select All</label>
                                </div>
                                <hr />
                                @foreach (var ticket in TicketTypes)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               checked="@newCode.ApplicableTicketTypeIds.Contains(ticket.Id)"
                                               @onchange="@(e => ToggleTicketType(ticket.Id, (bool)e.Value!))" />
                                        <label class="form-check-label">@ticket.Name - $@ticket.Price.ToString("F2")</label>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                    <small class="text-muted">Leave all unchecked to make code applicable to all ticket types</small>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3">@errorMessage</div>
            }
            <div class="mt-3">
                <button class="btn btn-primary" @onclick="CreateDiscountCode" disabled="@isSubmitting">
                    @if (isSubmitting) { <span class="spinner-border spinner-border-sm me-2"></span> }
                    Create
                </button>
                <button class="btn btn-secondary ms-2" @onclick="ToggleForm">Cancel</button>
            </div>
        </div>
    </div>
}

<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Uses</th>
                <th>Valid Period</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (!discountCodes.Any())
            {
                <tr>
                    <td colspan="7" class="text-center">No discount codes created yet.</td>
                </tr>
            }
            @foreach (var discount in discountCodes)
            {
                <tr>
                    <td><strong>@discount.Code</strong></td>
                    <td>@discount.DiscountType</td>
                    <td>
                        @if (discount.DiscountType == "Percentage")
                        {
                            <text>@discount.DiscountValue%</text>
                        }
                        else
                        {
                            <text>$@discount.DiscountValue.ToString("F2")</text>
                        }
                    </td>
                    <td>
                        @if (discount.MaxUses.HasValue)
                        {
                            <text>@discount.CurrentUses / @discount.MaxUses</text>
                        }
                        else
                        {
                            <text>@discount.CurrentUses / Unlimited</text>
                        }
                    </td>
                    <td>
                        <small>
                            @if (discount.ValidFrom.HasValue)
                            {
                                <div>From: @discount.ValidFrom.Value.ToString("MMM dd, yyyy")</div>
                            }
                            @if (discount.ValidUntil.HasValue)
                            {
                                <div>Until: @discount.ValidUntil.Value.ToString("MMM dd, yyyy")</div>
                            }
                            @if (!discount.ValidFrom.HasValue && !discount.ValidUntil.HasValue)
                            {
                                <text>Always valid</text>
                            }
                        </small>
                    </td>
                    <td><span class="badge bg-@GetStatusColor(discount.Status)">@discount.Status</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteDiscountCode(discount.Id)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter] public int EventId { get; set; }
    [Parameter] public List<TicketTypeResponse> TicketTypes { get; set; } = new();
    [Parameter] public EventCallback OnChanged { get; set; }

    private List<DiscountCodeResponse> discountCodes = new();
    private bool showForm;
    private bool isSubmitting;
    private string? errorMessage;
    private bool selectAllTickets;
    private NewDiscountCodeModel newCode = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDiscountCodes();
    }

    private async Task LoadDiscountCodes()
    {
        discountCodes = await ApiClient.GetDiscountCodesAsync(EventId);
    }

    private void ToggleForm()
    {
        showForm = !showForm;
        if (showForm)
        {
            newCode = new();
            selectAllTickets = false;
            errorMessage = null;
        }
    }

    private void ToggleTicketType(int ticketTypeId, bool isChecked)
    {
        if (isChecked)
        {
            if (!newCode.ApplicableTicketTypeIds.Contains(ticketTypeId))
            {
                newCode.ApplicableTicketTypeIds.Add(ticketTypeId);
            }
        }
        else
        {
            newCode.ApplicableTicketTypeIds.Remove(ticketTypeId);
        }
    }

    private void ToggleAllTickets()
    {
        if (selectAllTickets)
        {
            newCode.ApplicableTicketTypeIds = TicketTypes.Select(t => t.Id).ToList();
        }
        else
        {
            newCode.ApplicableTicketTypeIds.Clear();
        }
    }

    private async Task CreateDiscountCode()
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            var request = new CreateDiscountCodeRequest(
                newCode.Code?.ToUpper() ?? "",
                newCode.DiscountType ?? "Percentage",
                newCode.DiscountValue,
                newCode.MaxUses,
                newCode.ValidFrom,
                newCode.ValidUntil,
                newCode.ApplicableTicketTypeIds.Any() ? newCode.ApplicableTicketTypeIds : null
            );

            await ApiClient.CreateDiscountCodeAsync(EventId, request);
            await LoadDiscountCodes();
            await OnChanged.InvokeAsync();
            ToggleForm();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task DeleteDiscountCode(int discountCodeId)
    {
        try
        {
            await ApiClient.DeleteDiscountCodeAsync(discountCodeId);
            await LoadDiscountCodes();
            await OnChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private string GetStatusColor(string status) => status == "Active" ? "success" : "secondary";

    private class NewDiscountCodeModel
    {
        public string? Code { get; set; }
        public string? DiscountType { get; set; } = "Percentage";
        public decimal DiscountValue { get; set; } = 10m;
        public int? MaxUses { get; set; }
        public DateTime? ValidFrom { get; set; }
        public DateTime? ValidUntil { get; set; }
        public List<int> ApplicableTicketTypeIds { get; set; } = new();
    }
}
